#!/bin/bash
#
# Copyright (c) 2009, 2011, Oracle and/or its affiliates. All rights reserved.
# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
#
# This code is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License version 2 only, as
# published by the Free Software Foundation.
#
# This code is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
# version 2 for more details (a copy is included in the LICENSE file that
# accompanied this code).
#
# You should have received a copy of the GNU General Public License version
# 2 along with this work; if not, write to the Free Software Foundation,
# Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
#
# Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
# or visit www.oracle.com if you need additional information or have any
# questions.
#
# This script runs the Maxine inspector (on Linux).
#
CWD=`basename $PWD`
if [ "$CWD" != "VENative" ];
then
  echo "cwd is not in VENative package"
  exit 1
fi

MAXVE_ROOT=`dirname $PWD`
WS_ROOT=`dirname $MAXVE_ROOT`

echocmd=0
id=""
run=1
trace=1
dialog=""
commandfilearg=""
cp=""
cpb=""
vmargs=""
javacmd=`which java`
mode="attachwaiting"
target=""
location=""

while [ "$1" != "" ];
do
#  echo $1
  case $1 in
  "-echo" )
    echocmd=1
    ;;
  "-norun" )
    run=0
    echocmd=1;
    ;;
  "-trace" )
    shift
    trace="$1"
    ;;
  "-c" )
    shift
    commandfilearg="-c=$1"
    ;;
  "-xvm" )
    xvm=1
    ;;
  "-id" )
    shift
    id="-id=$1"
    ;;
  "-classpath" | "-cp" )
    shift
    cp="$1"
    ;;
  "-cpb" )
    shift
    cpb=$1
    ;;
  -J* )
    if [ "$vmargs" = "" ] ;
    then
      vmargs=${1/-J/}
    else
      vmargs="$vmargs ${1/-J/}"
    fi
    ;;
  "-java" )
    shift
    javacmd=$1
    ;;
    
  -tcp* )
    type=${1/-/}
    shift
    target="remote"
    location=$1
    if [ $type = "tcp.xga" ] ;
    then
        mode="attach"
    fi
    ;;
  "-dump" )
    shift
    mode="attach"
    target="file"
    location=$1
    ;;
  "-view" )
    mode="image"
    ;;
  * )
    ;;
  esac
  shift
done

BUILD_WS_ROOT="$WS_ROOT"
INS_WS_ROOT="$WS_ROOT"
IMAGE_WS_ROOT="$WS_ROOT"
MAX=$INS_WS_ROOT/maxine

classpath=$MAX/Inspector/bin:$MAX/Inspector/jlfgr-1_0.jar:$MAX/Inspector/NB3B.jar:$MAX/Tele/bin:$MAX/VMDI/bin:$MAX/VM/bin:$MAX/Base/bin:$MAX/Assembler/bin:$MAX/CPS/bin:$MAX/CRI/bin:$MAX/C1X/bin:$MAX/C0X/bin:$MAX/MaxineELF/bin:$MAXVE_ROOT/VETele/bin:$MAXVE_ROOT/VEMain/bin:$MAXVE_ROOT/VEBase/bin:$MAXVE_ROOT/JNodeFS/bin:$MAXVE_ROOT/YANFS/bin:$MAXVE_ROOT/NFSServer/bin:$MAXVE_ROOT/GNUCP/bin
if [ "$cp" != "" ] ;
then
  classpath=${classpath}:$cp
fi
if [ "$cpb" != "" ] ;
then
  classpath=${cpb}:${classpath}
fi
cmd="$javacmd -d64 $vmargs -Xbootclasspath/a:$MAXVE_ROOT/VEJDK/bin -classpath $classpath -Dmax.os=MaxVE -Dmax.os.signalcount=0 -Xms512m -Xmx1024m  com.sun.max.ins.MaxineInspector $id -trace=$trace -vmdir=$IMAGE_WS_ROOT/maxine/Native/generated/maxve $commandfilearg -mode=$mode -target=$target -location=$location"

if [ "$echocmd" -eq 1 ] ;
then
  echo "$cmd"
fi

if [ "$run" -eq 1 ] ;
then
  $cmd
fi

exit 0
